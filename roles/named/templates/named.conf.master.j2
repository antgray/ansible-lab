{{ ansible_managed | comment }}
# Generated by Ansible role {{ ansible_role_name }}

# BIND MASTER CONFIG FILE
include "/etc/rndc.key";

# Allow rndc management
controls {
	inet 127.0.0.1 port 953 allow { 127.0.0.1; } keys { "rndc-key"; };
};

acl "clients" {
	127.0.0.0/8;
	{{ homelab_address }}/{{ homelab_cidr_prefix }};
};

options {
	listen-on port 53 { 127.0.0.1; {{ homelab_dns1_server }}; }; ## MASTER
	listen-on-v6 { none; };
	directory 	"/var/named";
	dump-file 	"/var/named/data/cache_dump.db";
	statistics-file "/var/named/data/named_stats.txt";
	memstatistics-file "/var/named/data/named_mem_stats.txt";
	secroots-file	"/var/named/data/named.secroots";

	tcp-clients 25;

	version none;
	hostname none;
	server-id none;

	recursion no;
	allow-query { clients; };
	allow-transfer { localhost; {{ homelab_dns2_server }}; }; ## SLAVE

	auth-nxdomain no;
	notify no;
	dnssec-validation yes;

	bindkeys-file "/etc/named.iscdlv.key";
	managed-keys-directory "/var/named/dynamic";
	pid-file "/run/named/named.pid";
	session-keyfile "/run/named/session.key";

	/* https://fedoraproject.org/wiki/Changes/CryptoPolicy */
	include "/etc/crypto-policies/back-ends/bind.config";
};


logging {
    channel default_log {
        file "/var/named/log/default" versions 2 size 20m;
        print-time yes;
        print-category yes;
        print-severity yes;
        severity info;
    };
    channel auth_servers_log {
        file "/var/named/log/auth_servers" versions 100 size 20m;
        print-time yes;
        print-category yes;
        print-severity yes;
        severity info;
    };
    channel dnssec_log {
        file "/var/named/log/dnssec" versions 3 size 20m;
	print-time yes;
        print-category yes;
        print-severity yes;
        severity info;
    };
    channel zone_transfers_log {
	file "/var/named/log/zone_transfers" versions 3 size 20m;
	print-time yes;
        print-category yes;
        print-severity yes;
        severity info;
    };
    channel ddns_log {
	file "/var/named/log/ddns" versions 3 size 20m;
	print-time yes;
        print-category yes;
        print-severity yes;
        severity info;
    };
    channel client_security_log {
	file "/var/named/log/client_security" versions 3 size 20m;
	print-time yes;
        print-category yes;
        print-severity yes;
        severity info;
    };
    channel queries_log {
	file "/var/named/log/queries_log" versions 2 size 20m;
	print-time yes;
        print-category yes;
        print-severity yes;
        severity info;
    };

//
// This is the default syslog channel, defined here for clarity.  You don’t
// have to use it if you prefer to log to your own channels.
// It sends to syslog’s daemon facility, and sends only logged messages
// of priority info and higher.
// (The options to print time, category and severity are non-default.)
//
     channel default_syslog {
          print-time yes;
          print-category yes;
          print-severity yes;
          syslog daemon;
          severity info;
     };

//
// This is the default debug output channel, defined here for clarity.  You
// might want to redefine the output destination if it doesn’t fit with your
// local system administration plans for logging.  It is also a special
// channel that only produces output if the debug level is non-zero.
//
     channel default_debug {
          print-time yes;
          print-category yes;
          print-severity yes;
          file "named.run";
          severity dynamic;
     };


//
// Log routine stuff to syslog and default log:
//
     category default { default_syslog; default_debug; default_log; };
     category config { default_syslog; default_debug; default_log; };
     category dispatch { default_syslog; default_debug; default_log; };
     category network { default_syslog; default_debug; default_log; };
     category general { default_syslog; default_debug; default_log; };

//
// Log problems with DNSSEC:
//
     category dnssec { dnssec_log; default_debug; };
//
// Log together all messages relating to authoritative zone propagation
//
     category notify { zone_transfers_log; default_debug; };       
     category xfer-in { zone_transfers_log; default_debug; };       
     category xfer-out { zone_transfers_log; default_debug; };

//
// Log together all messages relating to dynamic updates to DNS zone data:
//
     category update{ ddns_log; default_debug; };
     category update-security { ddns_log; default_debug; };

//
// Log together all messages relating to client access and security.
// (There is an additional category ‘unmatched’ that is by default sent to
// null but which can be added here if you want more than the one-line
// summary that is logged for failures to match a view).
//
     category client{ client_security_log; default_debug; };       
     category security { client_security_log; default_debug; };
     category queries { queries_log; };

zone "{{ homelab_domain_name }}" {
	type master;
	file "master/master.{{ homelab_domain_name }}";
	allow-update { key rndc-key; };
	notify yes;
};

zone "{{ homelab_reverse_zone }}.in-addr.arpa" {
	type master;
	file "192.168.1.rev";
	allow-update { key rndc-key; };
	notify yes;
};
